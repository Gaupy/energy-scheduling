open Scanf ;;
open Printf ;;

let nheur = 8 in
let tab = Array.make nheur (0.,0.) in
let break = ref true in
(*let workon = ref true in*)
let proc = ref 0. in
let arretes = ref 0 in
(*let ratio = 2.4 in (* chose Ã  changer*)

Printf.printf "ratio deadline = %f\n" ratio;*)

let buff = ref (open_out ("proc_"^"0."^"_"^(string_of_int !arretes))) in 

while !break do
  try
    while true do
      let e0 = (scanf " %f " (fun f -> f)) in
      let e1 = (scanf " %f " (fun f -> f)) in
      let e2 = (scanf " %f " (fun f -> f)) in
      let e3 = (scanf " %f " (fun f -> f)) in
      let e4 = (scanf " %f " (fun f -> f)) in
      let e5 = (scanf " %f " (fun f -> f)) in
      let e6 = (scanf " %f " (fun f -> f)) in
        tab.(0) <- (1.,e0/.e1) ;
        tab.(1) <- (1.,1.) ;
	if e1 < 0. then failwith "Erreur dans l'energie de fr" ; 
        if e2 > 0. then (let r2 = e2/.e1 in let (j,r) = tab.(2) in tab.(2)<-(j+.1.,r+.r2)) ;
        if e3 > 0. then (let r3 = e3/.e1 in let (j,r) = tab.(3) in tab.(3)<-(j+.1.,r+.r3)) ;
        if e4 > 0. then (let r4 = e4/.e1 in let (j,r) = tab.(4) in tab.(4)<-(j+.1.,r+.r4)) ;
        if e5 > 0. then (let r5 = e5/.e1 in let (j,r) = tab.(5) in tab.(5)<-(j+.1.,r+.r5)) ;
        if e6 > 0. then (let r6 = e6/.e1 in let (j,r) = tab.(6) in tab.(6)<-(j+.1.,r+.r6)) ;
	let eB = min e2 (min e3 (min e4 (min e5 e6))) in 
	if eB > 0. then (let (j,r) = tab.(7) in tab.(7)<-(j+.1.,r+.(eB/.e1))) ;
    done
  with
    |Scan_failure _ ->
      begin

(*        if !workon then*)
          (
(*            workon := false ;*)
            fprintf !buff "%f\t" !proc ;
            let mi = ref max_float in
           for i = 0 to nheur-1 do
              let j,r = tab.(i) in
		if (j=0. && i <> nheur-1) then fprintf !buff "-1.\t"
                else 
                  (mi := min (r/.j) !mi; 
                   if i = nheur-1 then fprintf !buff "%f\t" !mi
                   else fprintf !buff "%f\t" (r/.j) );
                tab.(i)<-(0.,0.)
            done ;
            fprintf !buff "\n"
           ) ;

(*
        if !workon then
          (
(*            workon := false ;*)
            Printf.printf "%f\t" !proc ;
            for i = 0 to 6 do
              let j,r = tab.(i) in
                if j=0. then Printf.printf "-1.\t"
                else Printf.printf "%f\t" (r/.j) ;
                tab.(i)<-(0.,0.)
            done ;
            Printf.printf "\n"
           ) ;*)
        let s,f = (scanf " %s@= %f " (fun s f -> s,f)) in
          match s with
           | "ratio deadline " -> close_out !buff ; buff := open_out_gen [Open_append; Open_creat] 0o777 ("proc_"^(string_of_float f)^"_"^(string_of_int !arretes))
           | "nombre_de_proc " -> (proc:= f)
           | "nombre d'arretes sur 100 noeuds " -> arretes := int_of_float f
           | _ -> failwith s

(*
           | "nombre_de_proc " -> proc := f
           | "ratio deadline " -> if  f = ratio then workon := true else workon := false
           | "nombre d'arretes sur 100 noeuds " ->  Printf.printf "arretes = %f\n" f
           | _ -> failwith s*)
      end
    |End_of_file -> 
      begin
        break := false ;
        fprintf !buff "%f\t" !proc ;
(*        if !workon then*)
          let mi = ref max_float in
            for i = 0 to nheur-1 do
              let j,r = tab.(i) in
                if j=0. then fprintf !buff "-1.\t"
                else 
                  (mi := min (r/.j) !mi; 
                   if i = nheur-1 then fprintf !buff "%f\t" !mi
                   else fprintf !buff "%f\t" (r/.j)
                  );

                tab.(i)<-(0.,0.)
          done;
        fprintf !buff "\n" ;
      end
     | _ -> ()
(*
      begin
        break := false ;
        Printf.printf "%f\t" !proc ;
        if !workon then
          for i = 0 to 6 do
            let j,r = tab.(i) in
              if j=0. then Printf.printf "-1.\t"
              else Printf.printf "%f\t" (r/.j) ;
              tab.(i)<-(0.,0.)
          done
         else () ;
        Printf.printf "\n" ;
      end
     | _ -> ()*)
done

